{
    # Configuration globale
    email {$LETSENCRYPT_EMAIL}
    # Désactiver la télémétrie
    admin off
    # Compression automatique
    servers {
        protocol {
            experimental_http3
        }
    }
}

# ========================================
# DOMAINE PRINCIPAL (Database Manager)
# ========================================
{$DOMAIN} {
    # Compression automatique
    encode gzip zstd
    
    # Cache pour les assets statiques
    @static {
        path *.js *.css *.png *.jpg *.jpeg *.gif *.ico *.svg *.woff *.woff2 *.ttf *.eot
    }
    header @static Cache-Control "public, max-age=31536000, immutable"
    
    # Websocket/Longpolling pour Odoo (notifications temps réel)
    @websocket {
        path /websocket /longpolling/*
    }
    reverse_proxy @websocket odoo:8072 {
        header_up X-Forwarded-Proto {scheme}
        header_up X-Real-IP {remote_host}
        header_up Upgrade {http.request.header.Upgrade}
        header_up Connection {http.request.header.Connection}
    }
    
    # Route principale vers Odoo
    reverse_proxy odoo:8069 {
        # Headers pour de meilleures performances
        header_up X-Forwarded-Proto {scheme}
        header_up X-Real-IP {remote_host}
    }
    
    log {
        output file /var/log/caddy/main.log
    }
}

# Redirect www vers le domaine principal
www.{$DOMAIN} {
    redir https://{$DOMAIN}{uri} permanent
}

# ========================================
# CLIENTS - Import des configurations
# ========================================
# Ajoutez vos clients dans /caddy/sites/*.caddy
# Exemple: /caddy/sites/casaobras.caddy
import /caddy/sites/*.caddy

